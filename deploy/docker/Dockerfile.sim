FROM osrf/ros:jazzy-simulation

ENV DEBIAN_FRONTEND=noninteractive

# Gazebo bridge, ros2_control, visualization packages
RUN apt-get update && apt-get install -y --no-install-recommends \
    ros-jazzy-ros-gz \
    ros-jazzy-gz-ros2-control \
    ros-jazzy-ros2-control \
    ros-jazzy-ros2-controllers \
    ros-jazzy-joint-state-publisher \
    ros-jazzy-robot-state-publisher \
    ros-jazzy-rqt \
    ros-jazzy-rviz2 \
    # cv_bridge + python3-opencv: required by tracker_node (Step 4 parity check)
    # and by sim/generate_face_texture.py (numpy + cv2 face texture generation).
    # /usr/share/opencv4/haarcascades/ (NOT pulled in by python3-opencv itself).
    ros-jazzy-cv-bridge \
    python3-opencv \
    opencv-data \
    python3-colcon-common-extensions \
    python3-pip \
    xauth \
    && rm -rf /var/lib/apt/lists/*

# Data pipeline dependencies
RUN pip3 install --break-system-packages dvc h5py

# Workspace setup
WORKDIR /ws
RUN mkdir -p /ws/src

# Source ROS 2 and the workspace overlay in every interactive shell.
# Mesa software rendering vars: required for any Qt/GL app (rqt, rviz2) in the
# container â€” no hardware GPU is available, so we force llvmpipe via EGL.
RUN echo "source /opt/ros/jazzy/setup.bash" >> /etc/bash.bashrc && \
    echo '[[ -f /ws/install/setup.bash ]] && source /ws/install/setup.bash' >> /etc/bash.bashrc && \
    echo 'export LIBGL_ALWAYS_SOFTWARE=1' >> /etc/bash.bashrc && \
    echo 'export GALLIUM_DRIVER=llvmpipe' >> /etc/bash.bashrc && \
    echo 'export MESA_LOADER_DRIVER_OVERRIDE=llvmpipe' >> /etc/bash.bashrc && \
    echo 'export EGL_PLATFORM=surfaceless' >> /etc/bash.bashrc

CMD ["bash"]
